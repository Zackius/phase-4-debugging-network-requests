<!DOCTYPE html>

<html>
<head>
  <title>refix.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>refix.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The canonical list of redis commands</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>commands = <span class="hljs-built_in">require</span> <span class="hljs-string">'redis/lib/commands'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>All commands where the only key is the first argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>first =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(key, args...)</span> -&gt;</span>
      db[command] prefix + key, args...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'append'</span>
    <span class="hljs-string">'decr'</span>
    <span class="hljs-string">'decrby'</span>
    <span class="hljs-string">'dump'</span>
    <span class="hljs-string">'exists'</span>
    <span class="hljs-string">'expire'</span>
    <span class="hljs-string">'expireat'</span>
    <span class="hljs-string">'get'</span>
    <span class="hljs-string">'getbit'</span>
    <span class="hljs-string">'getrange'</span>
    <span class="hljs-string">'getset'</span>
    <span class="hljs-string">'hdel'</span>
    <span class="hljs-string">'hexists'</span>
    <span class="hljs-string">'hget'</span>
    <span class="hljs-string">'hgetall'</span>
    <span class="hljs-string">'hincrby'</span>
    <span class="hljs-string">'hincrbyfloat'</span>
    <span class="hljs-string">'hkeys'</span>
    <span class="hljs-string">'hlen'</span>
    <span class="hljs-string">'hmget'</span>
    <span class="hljs-string">'hmset'</span>
    <span class="hljs-string">'hset'</span>
    <span class="hljs-string">'hsetnx'</span>
    <span class="hljs-string">'hvals'</span>
    <span class="hljs-string">'incr'</span>
    <span class="hljs-string">'incrby'</span>
    <span class="hljs-string">'incrbyfloat'</span>
    <span class="hljs-string">'lindex'</span>
    <span class="hljs-string">'linsert'</span>
    <span class="hljs-string">'llen'</span>
    <span class="hljs-string">'lpop'</span>
    <span class="hljs-string">'lpush'</span>
    <span class="hljs-string">'lpushx'</span>
    <span class="hljs-string">'lrange'</span>
    <span class="hljs-string">'lrem'</span>
    <span class="hljs-string">'lset'</span>
    <span class="hljs-string">'ltrim'</span>
    <span class="hljs-string">'move'</span>
    <span class="hljs-string">'persist'</span>
    <span class="hljs-string">'pexpire'</span>
    <span class="hljs-string">'pexpireat'</span>
    <span class="hljs-string">'psetex'</span>
    <span class="hljs-string">'pttl'</span>
    <span class="hljs-string">'publish'</span>
    <span class="hljs-string">'restore'</span>
    <span class="hljs-string">'rpop'</span>
    <span class="hljs-string">'rpush'</span>
    <span class="hljs-string">'rpushx'</span>
    <span class="hljs-string">'sadd'</span>
    <span class="hljs-string">'scard'</span>
    <span class="hljs-string">'set'</span>
    <span class="hljs-string">'setbit'</span>
    <span class="hljs-string">'setex'</span>
    <span class="hljs-string">'setnx'</span>
    <span class="hljs-string">'setrange'</span>
    <span class="hljs-string">'sismember'</span>
    <span class="hljs-string">'smembers'</span>
    <span class="hljs-string">'spop'</span>
    <span class="hljs-string">'srandmember'</span>
    <span class="hljs-string">'srem'</span>
    <span class="hljs-string">'strlen'</span>
    <span class="hljs-string">'ttl'</span>
    <span class="hljs-string">'type'</span>
    <span class="hljs-string">'zadd'</span>
    <span class="hljs-string">'zcard'</span>
    <span class="hljs-string">'zcount'</span>
    <span class="hljs-string">'zincrby'</span>
    <span class="hljs-string">'zrange'</span>
    <span class="hljs-string">'zrangebyscore'</span>
    <span class="hljs-string">'zrank'</span>
    <span class="hljs-string">'zrem'</span>
    <span class="hljs-string">'zremrangebyrank'</span>
    <span class="hljs-string">'zremrangebyscore'</span>
    <span class="hljs-string">'zrevrange'</span>
    <span class="hljs-string">'zrevrangebyscore'</span>
    <span class="hljs-string">'zrevrank'</span>
    <span class="hljs-string">'zscore'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>All commands where all arguments (except an optional callback) are keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>all =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(keys...)</span> -&gt;</span>
      prefixed = prefixKeys prefix, keys
      db[command] prefixed...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'del'</span>
    <span class="hljs-string">'psubscribe'</span>
    <span class="hljs-string">'punsubscribe'</span>
    <span class="hljs-string">'subscribe'</span>
    <span class="hljs-string">'unsubscribe'</span>
    <span class="hljs-string">'watch'</span>
    <span class="hljs-string">'rpoplpush'</span>
    <span class="hljs-string">'mget'</span>
    <span class="hljs-string">'rename'</span>
    <span class="hljs-string">'renamenx'</span>
    <span class="hljs-string">'sdiff'</span>
    <span class="hljs-string">'sdiffstore'</span>
    <span class="hljs-string">'sinter'</span>
    <span class="hljs-string">'sinterstore'</span>
    <span class="hljs-string">'sunion'</span>
    <span class="hljs-string">'sunionstore'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>All commands where all arguments except the first is a key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exceptFirst =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(arg, keys...)</span> -&gt;</span>
      prefixed = prefixKeys prefix, keys
      db[command] arg, prefixed...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'bitop'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>All commands where all arguments except the last is a key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exceptLast =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(keys..., arg, cb)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> cb <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
        prefixed = prefixKeys prefix, keys
        db[command] prefixed..., arg, cb
      <span class="hljs-keyword">else</span>
        keys.push arg
        arg = cb
        prefixed = prefixKeys prefix, keys
        db[command] prefixed..., arg

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'blpop'</span>
    <span class="hljs-string">'brpop'</span>
    <span class="hljs-string">'brpoplpush'</span>
    <span class="hljs-string">'smove'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>All commands where every second argument is a key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>everySecond =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
      prefixed = []
      <span class="hljs-keyword">for</span> arg, index <span class="hljs-keyword">in</span> args
        <span class="hljs-keyword">if</span> index % <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> index <span class="hljs-keyword">is</span> args.length - <span class="hljs-number">1</span>
          prefixed.push arg
        <span class="hljs-keyword">else</span>
          prefixed.push prefix + arg

      db[command] prefixed...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'mset'</span>
    <span class="hljs-string">'msetnx'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Special case for migrate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>migrate =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(host, port, key, dest, timeout, next)</span> -&gt;</span>
      db[command] host, port, prefix + key, dest, timeout, next

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'migrate'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>All commands where the key arguments are specified as an argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>dynamic =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(dest, numKeys, args...)</span> -&gt;</span>
      keys = args.splice <span class="hljs-number">0</span>, numKeys
      prefixed = prefixKeys prefix, keys

      db[command] prefix + dest, numKeys, prefixed..., args...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'zinterstore'</span>
    <span class="hljs-string">'zunionstore'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Eval is just like dynamic, but not prefixing the script</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>evil =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(script, numKeys, args...)</span> -&gt;</span>
      keys = args.splice <span class="hljs-number">0</span>, numKeys
      prefixed = prefixKeys prefix, keys

      db[command] script, numKeys, prefixed..., args...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'eval'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Special case for sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>sort =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(key, args...)</span> -&gt;</span>
      prefixed = []
      lastArg = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> args
        <span class="hljs-keyword">if</span> lastArg.toLowerCase() <span class="hljs-keyword">is</span> <span class="hljs-string">'get'</span>
          prefixed.push prefix + arg
        <span class="hljs-keyword">else</span>
          prefixed.push arg

        lastArg = arg

      db[command] prefix + key, prefixed...

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'sort'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Special case for keys, returning the keys with the prefix stripped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>keys =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span>
    <span class="hljs-function"><span class="hljs-params">(pattern, next)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> next

      db[command] prefix + pattern, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> next err <span class="hljs-keyword">if</span> err

        next <span class="hljs-literal">null</span>, (k.substring(prefix.length) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> result)

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'keys'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Special case for multi, proxying the multi object itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>multi =
  <span class="hljs-attribute">proxy</span>: <span class="hljs-function"><span class="hljs-params">(command, prefix, db)</span> -&gt;</span><span class="hljs-function">
    -&gt;</span>
      prefixer(db.multi(), <span class="hljs-literal">true</span>) prefix

  <span class="hljs-attribute">commands</span>: [
    <span class="hljs-string">'multi'</span>
  ]</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The list of command proxies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>proxies = [
  first
  all
  exceptFirst
  exceptLast
  everySecond
  migrate
  dynamic
  evil
  sort
  keys
  multi
]</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Utility for prefixing all keys in an array, except if it’s a function
(for callbacks)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">prefixKeys</span> = <span class="hljs-params">(prefix, keys)</span> -&gt;</span>
  prefixed = <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> keys
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      key
    <span class="hljs-keyword">else</span>
      prefix + key</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Main entry point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = <span class="hljs-function"><span class="hljs-title">prefixer</span> = <span class="hljs-params">(db, chain)</span> -&gt;</span>
  <span class="hljs-function"><span class="hljs-params">(prefix)</span> -&gt;</span>
    proxy = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Proxy a command unchanged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-title">proxyCommand</span> = <span class="hljs-params">(command)</span> -&gt;</span>
      proxy[command] =<span class="hljs-function"> -&gt;</span> db[command].apply db, arguments

    <span class="hljs-keyword">for</span> command <span class="hljs-keyword">in</span> commands</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Find the proxy for this command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> proxies <span class="hljs-keyword">when</span> command <span class="hljs-keyword">in</span> p.commands
        <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(command)</span> -&gt;</span>
          c = p.proxy command, prefix, db
          proxy[command] =<span class="hljs-function"> -&gt;</span>
            r = c.apply db, arguments

            <span class="hljs-keyword">if</span> chain <span class="hljs-keyword">then</span> proxy <span class="hljs-keyword">else</span> r</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Proxy any unproxied commands unchanged</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      proxyCommand command <span class="hljs-keyword">unless</span> command <span class="hljs-keyword">of</span> proxy

    <span class="hljs-keyword">return</span> proxy</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
